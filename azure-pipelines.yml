trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend/**
      - frontend/**
      - shared/**

pool:
  name: Default

variables:
  - group: GitHubCredentials
  - group: RenderAPICredentials  # Nieuwe group voor Render API key

jobs:
- job: Deploy
  workspace:
    clean: all
  
  steps:
    # [Vorige stappen blijven hetzelfde tot aan de deploy stappen]
    
    # VERBETERDE Deploy Backend met Status Tracking
    - task: PowerShell@2
      displayName: "ğŸ”§ Deploy & Monitor Backend"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "    Backend Deployment with Status Monitoring"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Trigger deployment
          Write-Host "`nğŸš€ Triggering Backend Deploy..."
          try {
              $deployResponse = Invoke-WebRequest -Uri "https://api.render.com/deploy/srv-d2rejiuuk2gs73883gog?key=81rOk6VLwAk" -Method POST -UseBasicParsing
              Write-Host "âœ… Deploy triggered! Status: $($deployResponse.StatusCode)"
          } catch {
              Write-Host "âŒ Backend deploy trigger failed: $_"
              exit 1
          }
          
          # Wacht even voordat we status gaan checken
          Start-Sleep -Seconds 10
          
          # Monitor deployment status via Render API
          $serviceId = "srv-d2rejiuuk2gs73883gog"
          $renderApiKey = "$(RENDER_API_KEY)"  
          $maxWaitMinutes = 5
          $checkInterval = 10
          $maxAttempts = [math]::Floor($maxWaitMinutes * 60 / $checkInterval)
          $attempt = 0
          $deployComplete = $false
          
          Write-Host "`nğŸ“Š Monitoring deployment status..."
          Write-Host "Service ID: $serviceId"
          Write-Host "Max wait time: $maxWaitMinutes minutes"
          
          while ($attempt -lt $maxAttempts -and -not $deployComplete) {
              $attempt++
              Write-Host "`nğŸ”„ Check $attempt/$maxAttempts..."
              
              try {
                  # Get latest deploy status from Render API
                  $headers = @{
                      "Authorization" = "Bearer $renderApiKey"
                      "Accept" = "application/json"
                  }
                  
                  $statusUrl = "https://api.render.com/v1/services/$serviceId/deploys?limit=1"
                  $statusResponse = Invoke-RestMethod -Uri $statusUrl -Headers $headers -Method GET
                  
                  if ($statusResponse -and $statusResponse[0]) {
                      $latestDeploy = $statusResponse[0]
                      $deployStatus = $latestDeploy.status
                      $deployId = $latestDeploy.id
                      $commitId = $latestDeploy.commit.id.Substring(0, 7)
                      
                      Write-Host "ğŸ“¦ Deploy ID: $deployId"
                      Write-Host "ğŸ”– Commit: $commitId"
                      Write-Host "ğŸ“Š Status: $deployStatus"
                      
                      switch ($deployStatus) {
                          "live" {
                              Write-Host "âœ… Deployment is LIVE!"
                              $deployComplete = $true
                          }
                          "build_failed" {
                              Write-Host "âŒ Build FAILED!"
                              exit 1
                          }
                          "canceled" {
                              Write-Host "âš ï¸ Deployment was CANCELED"
                              exit 1
                          }
                          "deactivated" {
                              Write-Host "âš ï¸ Service is DEACTIVATED"
                              exit 1
                          }
                          default {
                              Write-Host "â³ Deployment still in progress..."
                              Start-Sleep -Seconds $checkInterval
                          }
                      }
                  }
              } catch {
                  Write-Host "âš ï¸ Error checking status: $_"
                  Start-Sleep -Seconds $checkInterval
              }
          }
          
          if (-not $deployComplete) {
              Write-Host "âŒ Deployment did not complete within $maxWaitMinutes minutes!"
              exit 1
          }
          
          # Extra verificatie: check health endpoint
          Write-Host "`nğŸ¥ Verifying backend health..."
          Start-Sleep -Seconds 10  # Geef service tijd om op te starten
          
          try {
              $healthResponse = Invoke-WebRequest -Uri "https://lunchmonkeys-backend.onrender.com/api/health" -Method GET -UseBasicParsing -TimeoutSec 30
              if ($healthResponse.StatusCode -eq 200) {
                  Write-Host "âœ… Backend health check passed!"
              }
          } catch {
              Write-Host "âš ï¸ Health check failed but deployment is live"
          }
    
    # VERBETERDE Deploy Frontend met Status Tracking
    - task: PowerShell@2
      displayName: "ğŸ¨ Deploy & Monitor Frontend"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "    Frontend Deployment with Status Monitoring"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Trigger deployment
          Write-Host "`nğŸš€ Triggering Frontend Deploy..."
          try {
              $deployResponse = Invoke-WebRequest -Uri "https://api.render.com/deploy/srv-d2reover433s73fiir2g?key=egSfMvGp7xs" -Method POST -UseBasicParsing
              Write-Host "âœ… Deploy triggered! Status: $($deployResponse.StatusCode)"
          } catch {
              Write-Host "âŒ Frontend deploy trigger failed: $_"
              exit 1
          }
          
          # Wacht even voordat we status gaan checken
          Start-Sleep -Seconds 10
          
          # Monitor deployment status
          $serviceId = "srv-d2reover433s73fiir2g"
          $renderApiKey = "$(RENDER_API_KEY)"
          $maxWaitMinutes = 15
          $checkInterval = 30
          $maxAttempts = [math]::Floor($maxWaitMinutes * 60 / $checkInterval)
          $attempt = 0
          $deployComplete = $false
          
          Write-Host "`nğŸ“Š Monitoring deployment status..."
          Write-Host "Service ID: $serviceId"
          Write-Host "Max wait time: $maxWaitMinutes minutes"
          
          while ($attempt -lt $maxAttempts -and -not $deployComplete) {
              $attempt++
              Write-Host "`nğŸ”„ Check $attempt/$maxAttempts..."
              
              try {
                  $headers = @{
                      "Authorization" = "Bearer $renderApiKey"
                      "Accept" = "application/json"
                  }
                  
                  $statusUrl = "https://api.render.com/v1/services/$serviceId/deploys?limit=1"
                  $statusResponse = Invoke-RestMethod -Uri $statusUrl -Headers $headers -Method GET
                  
                  if ($statusResponse -and $statusResponse[0]) {
                      $latestDeploy = $statusResponse[0]
                      $deployStatus = $latestDeploy.status
                      $deployId = $latestDeploy.id
                      $commitId = $latestDeploy.commit.id.Substring(0, 7)
                      
                      Write-Host "ğŸ“¦ Deploy ID: $deployId"
                      Write-Host "ğŸ”– Commit: $commitId"
                      Write-Host "ğŸ“Š Status: $deployStatus"
                      
                      switch ($deployStatus) {
                          "live" {
                              Write-Host "âœ… Deployment is LIVE!"
                              $deployComplete = $true
                          }
                          "build_failed" {
                              Write-Host "âŒ Build FAILED!"
                              exit 1
                          }
                          "canceled" {
                              Write-Host "âš ï¸ Deployment was CANCELED"
                              exit 1
                          }
                          default {
                              Write-Host "â³ Deployment still in progress..."
                              Start-Sleep -Seconds $checkInterval
                          }
                      }
                  }
              } catch {
                  Write-Host "âš ï¸ Error checking status: $_"
                  Start-Sleep -Seconds $checkInterval
              }
          }
          
          if (-not $deployComplete) {
              Write-Host "âŒ Deployment did not complete within $maxWaitMinutes minutes!"
              exit 1
          }
          
          Write-Host "`nğŸ‰ Frontend deployment successful!"
    
    # Finale summary
    - task: PowerShell@2
      displayName: "âœ¨ Deployment Summary"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘   âœ… LunchMonkeys Deployment Complete!    â•‘"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ Both services deployed and verified!       â•‘"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ Render URLs:                               â•‘"
          Write-Host "â•‘ Backend:  https://lunchmonkeys-backend.onrender.com"
          Write-Host "â•‘ Frontend: https://lunchmonkeys-frontend.onrender.com"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ Custom Domains:                            â•‘"
          Write-Host "â•‘ Backend:  https://api.lunchmonkeys.bluemonkeysaapp.nl"
          Write-Host "â•‘ Frontend: https://lunchmonkeys.bluemonkeysaapp.nl"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"