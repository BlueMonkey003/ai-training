trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend/**
      - frontend/**
      - shared/**

pool:
  name: Default

variables:
  - group: GitHubCredentials

steps:
  # Mirror complete monorepo naar GitHub
  - task: PowerShell@2
    displayName: "ğŸ“¤ Mirror Monorepo to GitHub"
    inputs:
      targetType: inline
      script: |
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        Write-Host "â•‘     Starting GitHub Mirror Process   â•‘"
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Clone repository
        Write-Host "`nğŸ“¥ Cloning repository..."
        git clone --depth 5 https://$(System.AccessToken)@dev.azure.com/bluemonkeys123/AI-training/_git/AI-training-application temp-repo
        
        if (-not $?) {
            Write-Host "âŒ Clone failed!"
            exit 1
        }
        
        cd temp-repo
        
        # Configure git
        git config user.email "azure-pipeline@bluemonkeys.nl"
        git config user.name "Azure Pipeline"
        
        # Verify structure
        Write-Host "`nğŸ“ Repository Structure:"
        Get-ChildItem | Format-Table Name, Mode, LastWriteTime
        
        # Check backend
        Write-Host "`nğŸ”§ Backend Status:"
        if (Test-Path "backend/package.json") {
            $backendPkg = Get-Content backend/package.json | ConvertFrom-Json
            Write-Host "âœ… Backend found: $($backendPkg.name) v$($backendPkg.version)"
        } else {
            Write-Host "âŒ Backend package.json not found!"
            exit 1
        }
        
        # Check frontend
        Write-Host "`nğŸ¨ Frontend Status:"
        if (Test-Path "frontend/package.json") {
            $frontendPkg = Get-Content frontend/package.json | ConvertFrom-Json
            Write-Host "âœ… Frontend found: $($frontendPkg.name) v$($frontendPkg.version)"
        } else {
            Write-Host "âŒ Frontend package.json not found!"
            exit 1
        }
        
        # Push to GitHub
        Write-Host "`nğŸ“¤ Pushing to GitHub..."
        git remote add github https://$(GITHUB_TOKEN)@github.com/BlueMonkey003/ai-training.git
        git push github HEAD:main --force
        
        if ($?) {
            Write-Host "âœ… Successfully mirrored to GitHub!"
        } else {
            Write-Host "âŒ Push to GitHub failed!"
            exit 1
        }
        
        # Cleanup
        cd ..
        Remove-Item -Recurse -Force temp-repo
        
        Write-Host "`nâœ¨ Mirror process completed!"

  # Wait for GitHub to process
  - script: |
      echo â³ Waiting 5 seconds for GitHub to process push...
      timeout /t 5
    displayName: "â±ï¸ Wait for GitHub"

  # Deploy Backend
  - task: PowerShell@2
    displayName: "ğŸ”§ Deploy Backend to Render"
    inputs:
      targetType: inline
      script: |
        Write-Host "ğŸš€ Triggering Backend Deploy..."
        try {
            $response = Invoke-WebRequest -Uri "https://api.render.com/deploy/srv-d2rejiuuk2gs73883gog?key=81rOk6VLwAk" -Method POST -UseBasicParsing
            Write-Host "âœ… Backend deploy triggered! Status: $($response.StatusCode)"
        } catch {
            Write-Host "âŒ Backend deploy failed: $_"
            exit 1
        }

  # Deploy Frontend
  - task: PowerShell@2
    displayName: "ğŸ¨ Deploy Frontend to Render"
    inputs:
      targetType: inline
      script: |
        Write-Host "ğŸš€ Triggering Frontend Deploy..."
        try {
            $response = Invoke-WebRequest -Uri "https://api.render.com/deploy/srv-d2reover433s73fiir2g?key=egSfMvGp7xs" -Method POST -UseBasicParsing
            Write-Host "âœ… Frontend deploy triggered! Status: $($response.StatusCode)"
        } catch {
            Write-Host "âŒ Frontend deploy failed: $_"
            exit 1
        }

  # Final status
  - script: |
      echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      echo â•‘   âœ… LunchMonkeys Deployment Complete!    â•‘
      echo â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
      echo â•‘ Backend:  https://api.lunchmonkeys.bluemonkeysaapp.nl
      echo â•‘ Frontend: https://lunchmonkeys.bluemonkeysaapp.nl
      echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    displayName: "âœ¨ Deployment Summary"