trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend/**
      - frontend/**
      - shared/**

pool:
  name: Default

variables:
  - group: GitHubCredentials

jobs:
- job: Deploy
  workspace:
    clean: all
  
  steps:
    # Diagnostiek blijft zoals het was
    - task: PowerShell@2
      displayName: "ğŸ” System Diagnostics"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "            SYSTEM DIAGNOSTICS"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          $os = Get-CimInstance Win32_OperatingSystem
          $totalRAM = [math]::Round($os.TotalVisibleMemorySize / 1024 / 1024, 2)
          $freeRAM = [math]::Round($os.FreePhysicalMemory / 1024 / 1024, 2)
          $usedRAM = $totalRAM - $freeRAM
          $percentUsed = [math]::Round(($usedRAM / $totalRAM) * 100, 2)
          
          Write-Host "`nğŸ“Š MEMORY STATUS:"
          Write-Host "Total RAM: $totalRAM GB"
          Write-Host "Used RAM: $usedRAM GB ($percentUsed%)"
          Write-Host "Free RAM: $freeRAM GB"
          
          if ($percentUsed -gt 85) {
              Write-Host "`nâš ï¸ Warning: High memory usage detected!"
          }
    
    # GEFIXTE Mirror naar GitHub
    - task: PowerShell@2
      displayName: "ğŸ“¤ Mirror Monorepo to GitHub"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘     Starting GitHub Mirror Process   â•‘"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          try {
              # Cleanup
              if (Test-Path "temp-repo") {
                  Write-Host "âš ï¸ Removing existing temp-repo..."
                  Remove-Item -Recurse -Force temp-repo
              }
              
              # BELANGRIJK: Clone met unshallow optie voor GitHub compatibility
              Write-Host "`nğŸ“¥ Cloning repository..."
              
              # Eerst shallow clone voor snelheid
              git clone --depth 1 --single-branch --branch main https://$(System.AccessToken)@dev.azure.com/bluemonkeys123/AI-training/_git/AI-training-application temp-repo
              
              if (-not $?) {
                  throw "Clone failed!"
              }
              
              cd temp-repo
              
              # Configure git
              git config user.email "azure-pipeline@bluemonkeys.nl"
              git config user.name "Azure Pipeline"
              
              # CRUCIALE FIX: Unshallow de repo voor GitHub
              Write-Host "`nğŸ”„ Fetching full history for GitHub compatibility..."
              git fetch --unshallow origin
              
              # Verify structure
              Write-Host "`nğŸ“ Repository Structure:"
              Get-ChildItem | Format-Table Name, Mode, LastWriteTime
              
              # Check backend
              Write-Host "`nğŸ”§ Backend Status:"
              if (Test-Path "backend/package.json") {
                  $backendPkg = Get-Content backend/package.json | ConvertFrom-Json
                  Write-Host "âœ… Backend found: $($backendPkg.name) v$($backendPkg.version)"
              }
              
              # Check frontend  
              Write-Host "`nğŸ¨ Frontend Status:"
              if (Test-Path "frontend/package.json") {
                  $frontendPkg = Get-Content frontend/package.json | ConvertFrom-Json
                  Write-Host "âœ… Frontend found: $($frontendPkg.name) v$($frontendPkg.version)"
              }
              
              # Add GitHub remote
              Write-Host "`nğŸ”— Adding GitHub remote..."
              git remote add github https://$(GITHUB_TOKEN)@github.com/BlueMonkey003/ai-training.git
              
              # Push to GitHub with force
              Write-Host "`nğŸ“¤ Pushing to GitHub..."
              git push github HEAD:main --force
              
              if ($?) {
                  Write-Host "âœ… Successfully mirrored to GitHub!"
              } else {
                  throw "Push to GitHub failed!"
              }
              
          } catch {
              Write-Host "âŒ Error occurred: $_"
              exit 1
          } finally {
              Write-Host "`nğŸ§¹ Performing cleanup..."
              cd $(Agent.WorkFolder)
              
              if (Test-Path "temp-repo") {
                  Remove-Item -Recurse -Force temp-repo -ErrorAction SilentlyContinue
              }
              
              [System.GC]::Collect()
          }
          
          Write-Host "`nâœ¨ Mirror process completed!"
    
    - task: PowerShell@2
      displayName: "â±ï¸ Wait for GitHub"
      inputs:
        targetType: inline
        script: |
          Write-Host "â³ Waiting 5 seconds for GitHub to process push..."
          Start-Sleep -Seconds 5
          Write-Host "âœ… Continue with deployments..."
    
    - task: PowerShell@2
      displayName: "ğŸ”§ Deploy Backend to Render"
      inputs:
        targetType: inline
        script: |
          Write-Host "ğŸš€ Triggering Backend Deploy..."
          try {
              $response = Invoke-WebRequest -Uri "https://api.render.com/deploy/srv-d2rejiuuk2gs73883gog?key=81rOk6VLwAk" -Method POST -UseBasicParsing
              Write-Host "âœ… Backend deploy triggered! Status: $($response.StatusCode)"
          } catch {
              Write-Host "âŒ Backend deploy failed: $_"
              exit 1
          }
    
    - task: PowerShell@2
      displayName: "ğŸ¨ Deploy Frontend to Render"
      inputs:
        targetType: inline
        script: |
          Write-Host "ğŸš€ Triggering Frontend Deploy..."
          try {
              $response = Invoke-WebRequest -Uri "https://api.render.com/deploy/srv-d2reover433s73fiir2g?key=egSfMvGp7xs" -Method POST -UseBasicParsing
              Write-Host "âœ… Frontend deploy triggered! Status: $($response.StatusCode)"
          } catch {
              Write-Host "âŒ Frontend deploy failed: $_"
              exit 1
          }
    
    # NIEUWE STAP: Health Check voor Backend
    - task: PowerShell@2
      displayName: "ğŸ¥ Backend Health Check"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "    Waiting for Backend Deployment & Health Check"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Gebruik root endpoint als health check nog niet bestaat
          $backendUrl = "https://lunchmonkeys-backend.onrender.com"  # Of gebruik een bestaande endpoint zoals /api/auth/check
          $maxRetries = 60  # 10 minuten max (60 x 10 seconden)
          $retryInterval = 10  # Wacht 10 seconden tussen checks
          $attemptCount = 0
          $success = $false
          
          Write-Host "`nğŸ”— Checking: $backendUrl"
          Write-Host "â±ï¸ Maximum wait time: 10 minutes"
          
          while ($attemptCount -lt $maxRetries -and -not $success) {
              $attemptCount++
              Write-Host "`nğŸ“ Attempt $attemptCount/$maxRetries..."
              
              try {
                  $response = Invoke-WebRequest -Uri $backendUrl -Method GET -UseBasicParsing -TimeoutSec 30
                  
                  if ($response.StatusCode -eq 200) {
                      Write-Host "âœ… Backend is healthy! Status: $($response.StatusCode)"
                      Write-Host "ğŸ“‹ Response: $($response.Content)"
                      $success = $true
                  } else {
                      Write-Host "âš ï¸ Unexpected status: $($response.StatusCode)"
                  }
              } catch {
                  Write-Host "â³ Backend not ready yet... (Error: $($_.Exception.Message))"
                  
                  if ($attemptCount -eq $maxRetries) {
                      Write-Host "âŒ Backend health check failed after $maxRetries attempts!"
                      exit 1
                  }
                  
                  Write-Host "â±ï¸ Waiting $retryInterval seconds before retry..."
                  Start-Sleep -Seconds $retryInterval
              }
          }
          
          if ($success) {
              Write-Host "`nğŸ‰ Backend deployment successful and healthy!"
          }
    
    # NIEUWE STAP: Health Check voor Frontend
    - task: PowerShell@2
      displayName: "ğŸ¥ Frontend Health Check"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "    Waiting for Frontend Deployment & Health Check"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          $frontendUrl = "https://lunchmonkeys-frontend.onrender.com"
          $maxRetries = 60  # 10 minuten max
          $retryInterval = 10  # Wacht 10 seconden tussen checks
          $attemptCount = 0
          $success = $false
          
          Write-Host "`nğŸ”— Checking: $frontendUrl"
          Write-Host "â±ï¸ Maximum wait time: 10 minutes"
          
          while ($attemptCount -lt $maxRetries -and -not $success) {
              $attemptCount++
              Write-Host "`nğŸ“ Attempt $attemptCount/$maxRetries..."
              
              try {
                  $response = Invoke-WebRequest -Uri $frontendUrl -Method GET -UseBasicParsing -TimeoutSec 30
                  
                  if ($response.StatusCode -eq 200) {
                      Write-Host "âœ… Frontend is live! Status: $($response.StatusCode)"
                      
                      # Check of het echt de React app is
                      if ($response.Content -like "*<!DOCTYPE html>*" -and $response.Content -like "*<div id=`"root`">*") {
                          Write-Host "âœ… React app verified!"
                          $success = $true
                      } else {
                          Write-Host "âš ï¸ Page loaded but doesn't look like the React app"
                      }
                  } else {
                      Write-Host "âš ï¸ Unexpected status: $($response.StatusCode)"
                  }
              } catch {
                  Write-Host "â³ Frontend not ready yet... (Error: $($_.Exception.Message))"
                  
                  if ($attemptCount -eq $maxRetries) {
                      Write-Host "âŒ Frontend health check failed after $maxRetries attempts!"
                      exit 1
                  }
                  
                  Write-Host "â±ï¸ Waiting $retryInterval seconds before retry..."
                  Start-Sleep -Seconds $retryInterval
              }
          }
          
          if ($success) {
              Write-Host "`nğŸ‰ Frontend deployment successful and live!"
          }
    
    # OPTIONELE STAP: Check custom domains (als certificaten issued zijn)
    - task: PowerShell@2
      displayName: "ğŸŒ Custom Domain Health Check (Optional)"
      continueOnError: true
      inputs:
        targetType: inline
        script: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "    Checking Custom Domains (if available)"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          $customDomains = @(
              @{
                  Name = "Frontend Custom Domain"
                  Url = "https://lunchmonkeys.bluemonkeysaapp.nl"
              },
              @{
                  Name = "Backend Custom Domain"
                  Url = "https://api.lunchmonkeys.bluemonkeysaapp.nl/api/health"
              }
          )
          
          foreach ($domain in $customDomains) {
              Write-Host "`nğŸ” Checking $($domain.Name): $($domain.Url)"
              
              try {
                  $response = Invoke-WebRequest -Uri $domain.Url -Method GET -UseBasicParsing -TimeoutSec 10
                  
                  if ($response.StatusCode -eq 200) {
                      Write-Host "âœ… $($domain.Name) is accessible! Status: $($response.StatusCode)"
                  }
              } catch {
                  Write-Host "âš ï¸ $($domain.Name) not available yet (SSL certificate may be pending)"
                  Write-Host "   Error: $($_.Exception.Message)"
              }
          }
          
          Write-Host "`nğŸ“ Note: Custom domains may take time for SSL certificates to be issued."
    
    - task: PowerShell@2
      displayName: "âœ¨ Deployment Summary"
      inputs:
        targetType: inline
        script: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘   âœ… LunchMonkeys Deployment Complete!    â•‘"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ Status: All health checks passed!          â•‘"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ Render URLs (Always Available):            â•‘"
          Write-Host "â•‘ Backend:  https://lunchmonkeys-backend.onrender.com"
          Write-Host "â•‘ Frontend: https://lunchmonkeys-frontend.onrender.com"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ Custom Domains (When SSL Ready):           â•‘"
          Write-Host "â•‘ Backend:  https://api.lunchmonkeys.bluemonkeysaapp.nl"
          Write-Host "â•‘ Frontend: https://lunchmonkeys.bluemonkeysaapp.nl"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"